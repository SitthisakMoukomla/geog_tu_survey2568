<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบสอบถามสำหรับผู้ทรงคุณวุฒิ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            transition: 0.2s all linear;
            margin-right: 0.5rem;
            position: relative;
            top: 4px;
        }
        .form-radio:checked {
            border: 6px solid #4f46e5;
        }
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            transition: 0.2s all linear;
            margin-right: 0.5rem;
            position: relative;
            top: 4px;
        }
        .form-checkbox:checked {
            background-color: #4f46e5;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        .rating-table-row {
            display: grid;
            grid-template-columns: 3fr 1fr 2fr;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
         .rating-table-row:nth-child(even) {
            background-color: #f9fafb;
        }
        .rating-table-row:last-child {
            border-bottom: none;
        }
        .section-subheader {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            background-color: #f3f4f6; /* bg-gray-100 */
            padding: 0.75rem; /* p-3 */
            margin-top: 1.5rem; /* mt-6 */
            border-radius: 0.5rem; /* rounded-lg */
        }
        .suggestion-box {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            border: 1px dashed #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        @media (max-width: 768px) {
            .rating-table-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-8 max-w-5xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-10">
            
            <div class="text-center mb-8">
                <img src="https://i.ibb.co/20gTzPZh/Emblem-of-Thammasat-University-svg.png" alt="Thammasat University Logo" class="mx-auto h-24 w-24 mb-4">
                <h1 class="text-xl sm:text-2xl font-bold text-indigo-700">แบบสอบถามการประเมินหลักสูตรวิทยาศาสตรบัณฑิต</h1>
                <p class="text-lg text-gray-700">สาขาวิชาภูมิศาสตร์และภูมิสารสนเทศ (หลักสูตรปรับปรุง พ.ศ. 2566 และ 2570)</p>
                <p class="text-gray-600 mt-2">สำหรับผู้ทรงคุณวุฒิ</p>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-10">
                <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 33%"></div>
            </div>

            <form id="surveyForm">
                <!-- ส่วนที่ 1 -->
                <div id="part1" class="space-y-6 survey-part">
                    <h2 class="text-xl font-bold border-b-2 border-indigo-200 pb-2">ส่วนที่ 1: ข้อมูลของผู้ตอบแบบสอบถาม</h2>
                    
                    <div><label for="expert_name" class="font-semibold">1. ชื่อ – นามสกุล (หากมีตำแหน่งทางวิชาการ โปรดระบุ)</label><input type="text" id="expert_name" name="expert_name" class="mt-2 w-full p-2 border rounded-md"></div>
                    <div><label for="age" class="font-semibold">2. ปัจจุบันท่านมีอายุ</label><input type="number" id="age" name="age" class="mt-2 w-full p-2 border rounded-md"></div>
                    <div><label class="font-semibold">3. การศึกษาขั้นสูงสุด</label><div class="grid sm:grid-cols-2 gap-2 mt-2"><label><input type="radio" name="education" value="bachelor" class="form-radio"> ปริญญาตรี</label><label><input type="radio" name="education" value="master" class="form-radio"> ปริญญาโท</label><label><input type="radio" name="education" value="doctorate" class="form-radio"> ปริญญาเอก</label><label><input type="radio" name="education" value="other" class="form-radio"> อื่นๆ <input type="text" name="education_other" class="ml-2 p-1 border-b" placeholder="ระบุ"></label></div></div>
                    <div>
                        <label class="font-semibold">4. ชื่อและที่ตั้งหน่วยงานของท่าน</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                            <input type="text" name="organization_name" placeholder="ชื่อหน่วยงาน/มหาวิทยาลัย" class="sm:col-span-2 p-2 border rounded-md">
                            <input type="text" name="organization_department" placeholder="กอง/สำนัก/ส่วนงาน/คณะ/สาขาวิชา" class="sm:col-span-2 p-2 border rounded-md">
                            <input type="text" name="address_no" placeholder="เลขที่" class="p-2 border rounded-md"><input type="text" name="address_soi" placeholder="ซอย" class="p-2 border rounded-md">
                            <input type="text" name="address_road" placeholder="ถนน" class="p-2 border rounded-md"><input type="text" name="address_subdistrict" placeholder="แขวง/ตำบล" class="p-2 border rounded-md">
                            <input type="text" name="address_district" placeholder="เขต/อำเภอ" class="p-2 border rounded-md"><input type="text" name="address_province" placeholder="จังหวัด" class="p-2 border rounded-md">
                            <input type="text" name="address_zip" placeholder="รหัสไปรษณีย์" class="p-2 border rounded-md"><input type="tel" name="address_phone" placeholder="โทร" class="p-2 border rounded-md">
                            <input type="tel" name="address_mobile" placeholder="โทรศัพท์เคลื่อนที่" class="p-2 border rounded-md"><input type="email" name="address_email" placeholder="e-mail address" class="sm:col-span-2 p-2 border rounded-md">
                        </div>
                    </div>
                    <div><label for="position" class="font-semibold">5. ปัจจุบันท่านดำรงตำแหน่ง</label><input type="text" id="position" name="position" class="mt-2 w-full p-2 border rounded-md"></div>
                    <div><label for="expertise" class="font-semibold">6. ท่านมีความเชี่ยวชาญทางด้านใด</label><input type="text" id="expertise" name="expertise" class="mt-2 w-full p-2 border rounded-md"></div>
                    <div><label class="font-semibold">7. ประสบการณ์การทำงานของท่านในตำแหน่งปัจจุบัน</label><div class="flex items-center space-x-2 mt-2"><input type="number" name="experience_year" class="w-20 p-2 border rounded-md" placeholder="ปี"><span>ปี</span><input type="number" name="experience_month" class="w-20 p-2 border rounded-md" placeholder="เดือน"><span>เดือน</span></div></div>
                    <div><label class="font-semibold">8. ประเภทของหน่วยงานที่ท่านทำงานอยู่</label><div class="grid sm:grid-cols-3 gap-2 mt-2"><label><input type="radio" name="org_type" value="gov" class="form-radio"> รัฐบาล</label><label><input type="radio" name="org_type" value="se" class="form-radio"> รัฐวิสาหกิจ</label><label><input type="radio" name="org_type" value="education" class="form-radio"> สถานศึกษา</label><label><input type="radio" name="org_type" value="ngo" class="form-radio"> องค์กรอิสระ / มูลนิธิ</label><label><input type="radio" name="org_type" value="private" class="form-radio"> เอกชน</label><label><input type="radio" name="org_type" value="other" class="form-radio"> อื่นๆ<input type="text" name="org_type_other" class="ml-2 p-1 border-b" placeholder="ระบุ"></label></div></div>
                    <div><label class="font-semibold">9. หน่วยงานของท่านส่วนใหญ่ใช้ความรู้ความสามารถในวิชาการด้านใดที่เกี่ยวกับภูมิศาสตร์</label><div class="space-y-2 mt-2"><label class="block"><input type="checkbox" name="geo_knowledge" value="map_reading" class="form-checkbox"> การอ่านแผนที่และการแปลตีความภาพถ่ายทางอากาศ</label><label class="block"><input type="checkbox" name="geo_knowledge" value="photogrammetry" class="form-checkbox"> โฟโตแกรมเมตรี</label><label class="block"><input type="checkbox" name="geo_knowledge" value="remote_sensing" class="form-checkbox"> การสัมผัสจากระยะไกล</label><label class="block"><input type="checkbox" name="geo_knowledge" value="gis" class="form-checkbox"> ระบบสารสนเทศทางภูมิศาสตร์</label><label class="block"><input type="checkbox" name="geo_knowledge" value="gps" class="form-checkbox"> การสำรวจด้วยดาวเทียม</label><label class="block"><input type="checkbox" name="geo_knowledge" value="teaching" class="form-checkbox"> จัดการเรียนการสอนด้านภูมิศาสตร์และภูมิสารสนเทศ</label><label class="block"><input type="checkbox" name="geo_knowledge" value="other" class="form-checkbox"> อื่นๆ<input type="text" name="geo_knowledge_other" class="ml-2 p-1 border-b" placeholder="ระบุ"></label></div></div>
                </div>

                <!-- ส่วนที่ 2 -->
                <div id="part2" class="space-y-6 survey-part hidden">
                    <h2 class="text-xl font-bold border-b-2 border-indigo-200 pb-2">ส่วนที่ 2: ความคิดเห็นเกี่ยวกับหลักสูตร พ.ศ. 2566</h2>
                    <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">
                        <p class="font-bold">คำแนะนำ</p>
                        <p>โปรดอ่านเอกสาร มคอ.2 ประกอบการตอบคำถามในส่วนนี้</p>
                        <a href="https://github.com/SitthisakMoukomla/geog_tu_survey2568/blob/main/%E0%B8%A1%E0%B8%84%E0%B8%AD2.%E0%B8%A7%E0%B8%97.%E0%B8%9A.%E0%B8%A0%E0%B8%B9%E0%B8%A1%E0%B8%B4%E0%B8%A8%E0%B8%B2%E0%B8%AA%E0%B8%95%E0%B8%A3%E0%B9%8C%E0%B9%81%E0%B8%A5%E0%B8%B0%E0%B8%A0%E0%B8%B9%E0%B8%A1%E0%B8%B4%E0%B8%AA%E0%B8%B2%E0%B8%A3%E0%B8%AA%E0%B8%99%E0%B9%80%E0%B8%97%E0%B8%A8(%E0%B8%AA%E0%B9%88%E0%B8%87%E0%B8%AD%E0%B8%A7).pdf" target="_blank" class="mt-2 inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                            เปิดเอกสาร มคอ.2.วทบ.ภูมิศาสตร์และภูมิสารสนเทศ.pdf
                        </a>
                    </div>

                    <div id="part2-questions-container"></div>
                </div>

                <!-- ส่วนที่ 3 -->
                <div id="part3" class="space-y-8 survey-part hidden">
                    <h2 class="text-xl font-bold border-b-2 border-indigo-200 pb-2">ส่วนที่ 3: แนวทางการปรับปรุงหลักสูตร พ.ศ. 2570</h2>
                    <div><label for="weakness_2566" class="font-semibold block">3.1 จุดอ่อนที่สำคัญของหลักสูตร พ.ศ. 2566 ที่ต้องปรับปรุง</label><textarea id="weakness_2566" name="weakness_2566" rows="4" class="mt-2 w-full p-2 border rounded-md"></textarea></div>
                    <div><label for="future_skills" class="font-semibold block">3.2 บัณฑิตควรมีความรู้ หรือทักษะอะไรเพิ่มเติมตามสถานการณ์ปัจจุบัน</label><textarea id="future_skills" name="future_skills" rows="4" class="mt-2 w-full p-2 border rounded-md"></textarea></div>
                    <div><label for="identity_strength" class="font-semibold block">3.3 หลักสูตรควรมีอัตลักษณ์หรือจุดแข็งด้านใด/อย่างไร</label><textarea id="identity_strength" name="identity_strength" rows="4" class="mt-2 w-full p-2 border rounded-md"></textarea></div>
                    <div><label for="grad_characteristics" class="font-semibold block">3.4 นักศึกษาที่จบจากหลักสูตรควรมีลักษณะ หรือจุดเด่นอย่างไร</label><textarea id="grad_characteristics" name="grad_characteristics" rows="4" class="mt-2 w-full p-2 border rounded-md"></textarea></div>
                    <div><label for="other_suggestions_2570" class="font-semibold block">3.5 ข้อเสนอแนะอื่นๆ เพิ่มเติม</label><textarea id="other_suggestions_2570" name="other_suggestions_2570" rows="4" class="mt-2 w-full p-2 border rounded-md"></textarea></div>
                </div>
                
                <div id="submissionStatus" class="hidden text-center p-4 my-4 rounded-md"></div>
                <div id="thankYouMessage" class="hidden text-center p-8">
                    <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h2 class="text-2xl font-bold mt-4">ส่งข้อมูลสำเร็จ!</h2>
                    <p class="text-gray-600 mt-2">ขอขอบพระคุณอย่างสูง เราได้รับข้อมูลของท่านเรียบร้อยแล้ว</p>
                </div>

                <div id="analysisSection" class="hidden text-left p-6 border-t-2 border-indigo-100 mt-8">
                    <h3 class="text-xl font-bold text-indigo-700 mb-4">วิเคราะห์ข้อเสนอแนะด้วย AI</h3>
                    <button type="button" id="analyzeBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition"><span class="mr-2">✨</span> วิเคราะห์และสรุปข้อเสนอแนะ</button>
                    <div id="loadingIndicator" class="mt-6 text-center hidden"><svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2 text-gray-600">กำลังวิเคราะห์ข้อมูล...</p></div>
                    <div id="analysisResult" class="mt-6 p-4 border rounded-lg bg-gray-50 hidden"></div>
                </div>

                <div class="flex justify-between mt-10">
                    <button type="button" id="prevBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">ก่อนหน้า</button>
                    <button type="button" id="nextBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">ถัดไป</button>
                    <button type="submit" id="submitBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg hidden">ส่งแบบสอบถาม</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DATA FOR DYNAMIC QUESTIONS ---
            const part2Questions = [
                { id: '2.1', title: 'หมวดที่ 1 ข้อมูลทั่วไป [มคอ.2 หน้า 1-3]' },
                { id: '2.2', title: 'หมวดที่ 2 คุณสมบัติผู้เข้าศึกษาและแผนการรับนักศึกษา [มคอ.2 หน้า 4-5]' },
                { id: '2.3', title: 'หมวดที่ 3 ปรัชญา วัตถุประสงค์ และผลลัพธ์การเรียนรู้ของหลักสูตร [มคอ.2 หน้า 6-10]' },
                { id: '2.4', title: 'Custom Section Placeholder' },
                { id: '2.5', title: 'หมวดที่ 5 การจัดกระบวนการเรียนรู้ [มคอ.2 หน้า 41-44]' },
                { id: '2.6', title: 'หมวดที่ 6 ความพร้อมและศักยภาพในการบริหารจัดการหลักสูตร [มคอ.2 หน้า 45-48]' },
                { id: '2.7', title: 'หมวดที่ 7 การประเมินผลการเรียนและเกณฑ์การสำเร็จการศึกษา [มคอ.2 หน้า 49]' },
                { id: '2.8', title: 'หมวดที่ 8 การประกันคุณภาพหลักสูตร [มคอ.2 หน้า 50]' },
                { id: '2.9', title: 'หมวดที่ 9 ระบบและกลไกในการพัฒนาหลักสูตร [มคอ.2 หน้า 51-57]' }
            ];

            const table241Data = {
                "วิชาศึกษาทั่วไป (30 หน่วยกิต)": [
                    { course: "เลือกเรียนให้ครบทั้ง 5 หมวด", credit: "30" },
                    { course: "1.2.1 สษ.105 ทักษะการสื่อสารทางภาษาอังกฤษ (บังคับ)", credit: "3 (3-0-6)" },
                    { course: "1.3.1 มธ.151 หรือ 1.3.2 มธ.152 (เลือก 1)", credit: "3" },
                ],
                "วิชาเฉพาะ (84 หน่วยกิต)": [
                    { course: "2.1 วิชาแกนคณะ (รวม)", credit: "12" },
                    { course: "2.1.1 ท.291 การพัฒนาสมรรถภาพการเขียน", credit: "3 (3-0-6)" },
                    { course: "2.1.2 อ.211 การฟัง-พูด", credit: "3 (3-0-6)" },
                    { course: "2.1.3 อ.214 ทักษะการนำเสนอ", credit: "3 (3-0-6)" },
                    { course: "2.1.4 อ.221 การอ่านและการเขียนเชิงบูรณาการ", credit: "3 (3-0-6)" },
                    { course: "2.2 วิชาในสาขา (รวม)", credit: "72" },
                    { course: "2.2.1 วิชาบังคับ (รวม)", credit: "42" },
                    { course: "1) ภม.111 ภูมิศาสตร์กายภาพ : ธรณีภาคและอุทกภาค", credit: "3 (3-0-6)" },
                    { course: "2) ภม.112 ภูมิศาสตร์กายภาพ : บรรยากาศภาคและชีวภาค", credit: "3 (3-0-6)" },
                    { course: "3) ภม.121 ภูมิศาสตร์มนุษย์", credit: "3 (3-0-6)" },
                    { course: "4) ภม.122 ภูมิศาสตร์ประเทศไทย", credit: "3 (3-0-6)" },
                    { course: "5) ภม.131 การอ่านแผนที่และการทำแผนที่ดิจิทัล", credit: "3 (3-0-6)" },
                    { course: "6) ภม.221 ภูมิศาสตร์ภูมิภาคโลก", credit: "3 (3-0-6)" },
                    { course: "7) ภม.231 ระบบนำทางด้วยดาวเทียมและการสำรวจภาคสนาม", credit: "3 (2-2-5)" },
                    { course: "8) ภม.232 ระบบสารสนเทศภูมิศาสตร์", credit: "3 (2-3-4)" },
                    { course: "9) ภม.233 ดิจิทัลโฟโตแกรมเมตรี", credit: "3 (2-3-4)" },
                    { course: "10) ภม.234 การโปรแกรมพื้นฐานสำหรับนักภูมิศาสตร์", credit: "3 (2-3-4)" },
                    { course: "11) ภม.331 การสำรวจจากระยะไกลด้วยดาวเทียม", credit: "3 (2-3-4)" },
                    { course: "12) ภม.341 สถิติเพื่อการวิจัยทางภูมิศาสตร์", credit: "3 (2-3-4)" },
                    { course: "13) ภม.441 ระเบียบวิธีวิจัยทางภูมิศาสตร์", credit: "3 (3-0-6)" },
                    { course: "14) ภม.442 การวิจัยทางภูมิศาสตร์เฉพาะบุคคล", credit: "3 (0-4-5)" },
                    { course: "2.2.2 วิชาบังคับเลือก (รวม)", credit: "30" },
                ],
                "วิชาโทหรือวิชาเลือก": [ { course: "รวม", credit: "18" } ],
                "วิชาเลือกเสรี": [ { course: "รวม", credit: "6" } ]
            };
            
            const table242Data = {
                "วิชาศึกษาทั่วไป": ["จำนวนหน่วยกิตรวม 30 หน่วยกิต", "เนื้อหาวิชามีความทันสมัย", "เนื้อหาวิชาสามารถนำไปปรับใช้ในชีวิตประจำวัน", "เนื้อหาวิชาสนับสนุนจุดมุ่งหมายของหลักสูตร"],
                "วิชาเฉพาะ": ["จำนวนหน่วยกิตรวม 84 หน่วยกิต", "วิชาแกนคณะ 12 หน่วยกิต", "วิชาเฉพาะในสาขา- กลุ่มวิชาบังคับ 42 หน่วยกิต", "วิชาเฉพาะในสาขา- กลุ่มวิชาบังคับเลือก 30 หน่วยกิต", "วิชาเฉพาะในสาขา มีความทันสมัย", "วิชาเฉพาะในสาขา มีความสอดคล้องกับตลาดแรงงาน", "สัดส่วนระหว่างวิชาเฉพาะในคณะ กับวิชาเฉพาะในสาขา", "สัดส่วนระหว่างวิชาบังคับกับวิชาบังคับเลือก"],
                "วิชาโทหรือวิชาเลือก": ["จำนวนหน่วยกิตรวม 18 หน่วยกิต", "ความทันสมัย", "ความสอดคล้องกับตลาดแรงงาน"],
                "วิชาเลือกเสรี": ["จำนวนหน่วยกิตรวม 6 หน่วยกิต", "ความทันสมัย", "ความสอดคล้องกับตลาดแรงงาน"],
                "โครงสร้างหลักสูตร": ["หน่วยกิตรวมตลอดหลักสูตรไม่น้อยกว่า 138 หน่วยกิต", "สัดส่วนวิชาศึกษาทั่วไป วิชาเฉพาะ วิชาโท และเลือกเสรี", "โครงสร้างและรายวิชาสอดคล้องกับจุดมุ่งหมาย", "ความชัดเจนของอัตลักษณ์/ความแตกต่างจากสถาบันอื่น"]
            };

            const options3Point = [{ text: 'เหมาะสม', value: '3' }, { text: 'ควรปรับปรุง', value: '2' }, { text: 'ไม่มีความเห็น', value: '1' }];

            // !!! IMPORTANT !!! PASTE YOUR GOOGLE APPS SCRIPT URL HERE
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyoPmWadvLxFBc-ZktWPIDlGUEh7_a_klJwNErOt5cAcfRRshHEfGlQESE2JpmGQA-J1A/exec';

            let currentPart = 1;
            const totalParts = 3;
            const parts = document.querySelectorAll('.survey-part');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const progressBar = document.getElementById('progress-bar');
            const form = document.getElementById('surveyForm');
            const thankYouMessage = document.getElementById('thankYouMessage');
            const submissionStatus = document.getElementById('submissionStatus');
            const analysisSection = document.getElementById('analysisSection');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const analysisResult = document.getElementById('analysisResult');
            const loadingIndicator = document.getElementById('loadingIndicator');
            let allSuggestions = '';

            // --- Populate Part 2 ---
            const part2Container = document.getElementById('part2-questions-container');
            part2Questions.forEach(q => {
                if (q.id === '2.4') {
                    part2Container.insertAdjacentHTML('beforeend', `
                        <div class="space-y-4">
                            <h3 class="section-subheader">2.4 โครงสร้างหลักสูตร หมวดที่ 4 [มคอ.2 หน้า 11-40]</h3>
                            <div class="p-4 border rounded-md">
                                <h4 class="font-semibold text-lg mb-2">2.4.1 รายวิชาและหน่วยกิตในหลักสูตร</h4>
                                <div id="table-241-container"></div>
                                <label for="suggestion_2_4_1" class="font-semibold mt-4 block">ความเห็นเพิ่มเติม (2.4.1)</label>
                                <textarea id="suggestion_2_4_1" name="suggestion_2_4_1" rows="3" class="mt-2 w-full p-2 border rounded-md"></textarea>
                            </div>
                            <div class="p-4 border rounded-md mt-6">
                                <h4 class="font-semibold text-lg mb-2">2.4.2 โครงสร้างองค์ประกอบจำนวนหน่วยกิต</h4>
                                <div id="table-242-container"></div>
                                <label for="suggestion_2_4_2" class="font-semibold mt-4 block">ความเห็นเพิ่มเติม (2.4.2)</label>
                                <textarea id="suggestion_2_4_2" name="suggestion_2_4_2" rows="3" class="mt-2 w-full p-2 border rounded-md"></textarea>
                            </div>
                        </div>
                    `);
                } else {
                     part2Container.insertAdjacentHTML('beforeend', `
                        <div class="space-y-2 suggestion-group">
                            <h3 class="section-subheader">${q.id} ${q.title}</h3>
                            <div class="flex items-center space-x-4 mt-2">
                                <label><input type="radio" name="suggestion_type_${q.id}" value="no_suggestion" class="form-radio" checked> ไม่มีประเด็นเสนอแนะ</label>
                                <label><input type="radio" name="suggestion_type_${q.id}" value="has_suggestion" class="form-radio"> มีประเด็นเสนอแนะ</label>
                            </div>
                            <div class="suggestion-box">
                                <textarea name="suggestion_text_${q.id}" rows="3" class="w-full p-2 border rounded-md"></textarea>
                            </div>
                        </div>
                    `);
                }
            });

            const table241Container = document.getElementById('table-241-container');
            if (table241Container) {
                let table241Html = `<div class="border rounded-lg overflow-hidden"><div class="rating-table-row font-bold bg-gray-50"><div class="pl-2">ประเด็น</div><div>หน่วยกิต</div><div>ระดับความคิดเห็น</div></div>`;
                Object.entries(table241Data).forEach(([group, courses]) => {
                    table241Html += `<div class="font-bold bg-gray-100 p-2 col-span-3">${group}</div>`;
                    courses.forEach((item, index) => {
                        const name = `table241_${group.replace(/[^a-zA-Z0-9]/g, '')}_${index}`;
                        table241Html += `
                            <div class="rating-table-row">
                                <div class="pl-4">${item.course}</div>
                                <div>${item.credit}</div>
                                <div>
                                    <select name="${name}" class="w-full p-2 border rounded-md">
                                        ${options3Point.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                                    </select>
                                </div>
                            </div>`;
                    });
                });
                table241Container.innerHTML = table241Html + `</div>`;
            }

            const table242Container = document.getElementById('table-242-container');
            if (table242Container) {
                let table242Html = `<div class="border rounded-lg overflow-hidden"><div class="rating-table-row font-bold bg-gray-50"><div class="pl-2">ประเด็น</div><div class="col-span-2">ระดับความคิดเห็น</div></div>`;
                Object.entries(table242Data).forEach(([group, items]) => {
                     table242Html += `<div class="font-bold bg-gray-100 p-2 col-span-3">${group}</div>`;
                     items.forEach((item, index) => {
                        const name = `table242_${group.replace(/[^a-zA-Z0-9]/g, '')}_${index}`;
                        table242Html += `
                            <div class="rating-table-row">
                                <div class="pl-4">${item}</div>
                                <div class="col-span-2">
                                    <select name="${name}" class="w-full p-2 border rounded-md">
                                         ${options3Point.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        `;
                     });
                });
                table242Container.innerHTML = table242Html + `</div>`;
            }

            document.querySelectorAll('.suggestion-group input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', event => {
                    const box = event.target.closest('.suggestion-group').querySelector('.suggestion-box');
                    if (event.target.value === 'has_suggestion') {
                        box.style.display = 'block';
                    } else {
                        box.style.display = 'none';
                    }
                });
            });

            function showPart(partNumber) {
                parts.forEach(part => part.classList.add('hidden'));
                document.getElementById(`part${partNumber}`).classList.remove('hidden');
                updateButtons(partNumber);
                progressBar.style.width = `${(partNumber / totalParts) * 100}%`;
            }

            function updateButtons(partNumber) {
                prevBtn.style.visibility = (partNumber === 1) ? 'hidden' : 'visible';
                nextBtn.classList.toggle('hidden', partNumber === totalParts);
                submitBtn.classList.toggle('hidden', partNumber !== totalParts);
            }

            nextBtn.addEventListener('click', () => { if (currentPart < totalParts) showPart(++currentPart); window.scrollTo(0, 0); });
            prevBtn.addEventListener('click', () => { if (currentPart > 1) showPart(--currentPart); window.scrollTo(0, 0); });
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (scriptURL === 'https://script.google.com/macros/s/AKfycbyoPmWadvLxFBc-ZktWPIDlGUEh7_a_klJwNErOt5cAcfRRshHEfGlQESE2JpmGQA-J1A/exec') {
                    submissionStatus.textContent = 'ข้อผิดพลาด: กรุณาใส่ URL ของ Google Apps Script ในโค้ดก่อน';
                    submissionStatus.className = 'text-center p-4 my-4 rounded-md bg-red-100 text-red-800';
                    return;
                }
                submitBtn.disabled = true;
                submitBtn.textContent = 'กำลังส่ง...';
                submitBtn.classList.add('opacity-50');
                
                fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                    .then(response => response.json())
                    .then(data => {
                        console.log('Success!', data);
                        allSuggestions = [...form.querySelectorAll('textarea')].map(ta => ta.value.trim() ? `หัวข้อ: ${document.querySelector(`label[for="${ta.id}"]`)?.textContent || 'ข้อเสนอแนะ'}\nเนื้อหา: ${ta.value.trim()}` : '').filter(Boolean).join('\n\n---\n\n');
                        parts.forEach(part => part.classList.add('hidden'));
                        document.querySelector('.flex.justify-between').classList.add('hidden');
                        document.getElementById('progress-bar').parentElement.classList.add('hidden');
                        thankYouMessage.classList.remove('hidden');
                        if (allSuggestions) analysisSection.classList.remove('hidden');
                        window.scrollTo(0, 0);
                    })
                    .catch(error => {
                        console.error('Error!', error.message);
                        submissionStatus.textContent = 'เกิดข้อผิดพลาดในการส่งข้อมูล กรุณาตรวจสอบการตั้งค่า Google Sheet และลองใหม่อีกครั้ง';
                        submissionStatus.className = 'text-center p-4 my-4 rounded-md bg-red-100 text-red-800';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ส่งแบบสอบถาม';
                        submitBtn.classList.remove('opacity-50');
                    });
            });

            analyzeBtn.addEventListener('click', async () => {
                loadingIndicator.classList.remove('hidden');
                analysisResult.classList.add('hidden');
                analyzeBtn.disabled = true;
                analyzeBtn.classList.add('opacity-50');
                const prompt = `คุณคือผู้เชี่ยวชาญด้านการพัฒนาหลักสูตรการศึกษา โปรดวิเคราะห์และสรุปข้อเสนอแนะจากผู้ทรงคุณวุฒิสำหรับหลักสูตรภูมิศาสตร์ โดยจัดระเบียบคำตอบตามหัวข้อ: 1. **สรุปประเด็นสำคัญ**, 2. **จุดแข็งของหลักสูตร**, 3. **ประเด็นที่ควรพิจารณาเพื่อการปรับปรุง**, 4. **ข้อเสนอแนะเชิงปฏิบัติ 2-3 ข้อ**. ข้อมูล: --- ${allSuggestions} ---`;
                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    let response;
                    for (let i = 0, delay = 1000; i < 5; i++, delay *= 2) {
                        try {
                            const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                            if (res.ok) { response = res; break; }
                            if (res.status === 429 || res.status >= 500) await new Promise(r => setTimeout(r, delay));
                            else throw new Error(`API request failed with status ${res.status}`);
                        } catch (error) { if (i === 4) throw error; await new Promise(r => setTimeout(r, delay)); }
                    }
                    if (!response) throw new Error('API request failed after multiple retries.');
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        analysisResult.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*/g, '<br> &bull; ').replace(/\n/g, '<br>');
                    } else { throw new Error('Invalid API response structure.'); }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    analysisResult.innerHTML = `<p class="text-red-500">เกิดข้อผิดพลาดในการเชื่อมต่อกับ AI: ${error.message}</p>`;
                } finally {
                    loadingIndicator.classList.add('hidden');
                    analysisResult.classList.remove('hidden');
                    analyzeBtn.disabled = false;
                    analyzeBtn.classList.remove('opacity-50');
                }
            });
            showPart(currentPart);
        });
    </script>
</body>
</html>
